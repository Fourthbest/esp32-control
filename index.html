<!-- Agrega Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>
  // Tu configuraci처n de Firebase (reemplaza esto con la tuya propia)
  const firebaseConfig = {
      apiKey: "AIzaSyAXGIyoNj2_YUDCIwk8g4SstUKvAritEBk",
      authDomain: "esp32monitoreocontrol.firebaseapp.com",
      databaseURL: "https://esp32monitoreocontrol-default-rtdb.firebaseio.com",
      projectId: "esp32monitoreocontrol",
      storageBucket: "esp32monitoreocontrol.firebasestorage.app",
      messagingSenderId: "840629264771",
      appId: "1:840629264771:web:31da23c48e77f8a01cd6b6"
  };

  // Inicializa Firebase
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const tempElement = document.getElementById('temperatura');
  const humidityElement = document.getElementById('humedad');
  const relayStatusElement = document.getElementById('estado-rele');
  const servoPositionElement = document.getElementById('posicion-servo');
  const servoSlider = document.getElementById('range-servo');
  const loadingElement = document.getElementById('loading');

  // Ocultar loading al inicio
  window.onload = function () {
    loadingElement.style.display = 'none';
    readSensorData();
  };

  function readSensorData() {
    loadingElement.style.display = 'flex';
    loadingElement.innerText = 'Cargando datos desde Firebase...';

    db.ref('/sensores').once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (data) {
          const temp = parseFloat(data.temperatura);
          const hum = parseFloat(data.humedad);
          const rele = parseInt(data.rele);
          const servo = parseInt(data.servo);

          tempElement.innerText = isNaN(temp) ? '--' : temp.toFixed(1);
          humidityElement.innerText = isNaN(hum) ? '--' : hum.toFixed(1);

          if (rele === 1) {
            relayStatusElement.innerText = 'ENCENDIDO';
            relayStatusElement.className = 'status-on';
          } else {
            relayStatusElement.innerText = 'APAGADO';
            relayStatusElement.className = 'status-off';
          }

          servoPositionElement.innerText = servo + '째';
          servoSlider.value = servo;
        }

        loadingElement.style.display = 'none';
      })
      .catch(error => {
        console.error("Error al leer de Firebase:", error);
        loadingElement.innerText = 'Error al cargar datos';
        setTimeout(() => loadingElement.style.display = 'none', 2000);
      });
  }

  function sendCommand(path, value) {
    loadingElement.style.display = 'flex';
    loadingElement.innerText = 'Enviando comando a Firebase...';

    db.ref(`/comandos/${path}`).set(value)
      .then(() => {
        loadingElement.innerText = 'Comando enviado';
        setTimeout(() => loadingElement.style.display = 'none', 1000);

        if (path === 'rele') {
          relayStatusElement.innerText = value === 1 ? 'ENCENDIDO' : 'APAGADO';
          relayStatusElement.className = value === 1 ? 'status-on' : 'status-off';
        } else if (path === 'servo') {
          servoPositionElement.innerText = value + '째';
        }
      })
      .catch(error => {
        console.error("Error al enviar comando:", error);
        loadingElement.innerText = 'Error al enviar comando';
        setTimeout(() => loadingElement.style.display = 'none', 2000);
      });
  }

  // Botones
  document.getElementById('btn-encender').addEventListener('click', () => {
    sendCommand('rele', 1);
  });

  document.getElementById('btn-apagar').addEventListener('click', () => {
    sendCommand('rele', 0);
  });

  servoSlider.addEventListener('input', function () {
    servoPositionElement.innerText = this.value + '째';
  });

  document.getElementById('btn-servo').addEventListener('click', () => {
    const pos = parseInt(servoSlider.value);
    sendCommand('servo', pos);
  });

  document.getElementById('btn-actualizar').addEventListener('click', () => {
    readSensorData();
  });
</script>
